##  ICC Point Table
```sql
CREATE TABLE ICC_WORLD_CUP
(
TEAM_1 VARCHAR(20),
TEAM_2 VARCHAR(20),
WINNER VARCHAR(20)
);
INSERT INTO ICC_WORLD_CUP VALUES('India','SL','India');
INSERT INTO ICC_WORLD_CUP VALUES('SL','Aus','Aus');
INSERT INTO ICC_WORLD_CUP VALUES('SA','Eng','Eng');
INSERT INTO ICC_WORLD_CUP VALUES('Eng','NZ','NZ');
INSERT INTO ICC_WORLD_CUP VALUES('Aus','India','India');

SELECT 
  TEAM_NAME, 
  COUNT(*) AS MATCHES_PLAYED, 
  SUM(WIN_FLAG) AS NO_OF_WINS, 
  COUNT(*)- SUM(WIN_FLAG) AS NO_OF_LOSSES 
FROM 
  (
    SELECT 
      TEAM_1 AS TEAM_NAME, 
      CASE WHEN WINNER = TEAM_1 THEN 1 ELSE 0 END AS WIN_FLAG 
    FROM 
      ICC_WORLD_CUP 
    UNION ALL 
    SELECT 
      TEAM_2 AS TEAM_NAME, 
      CASE WHEN WINNER = TEAM_2 THEN 1 ELSE 0 END AS WIN_FLAG 
    FROM 
      ICC_WORLD_CUP
  ) DATA 
GROUP BY 
  TEAM_NAME 
ORDER BY 
  3 DESC;
```
##  Employees having salary greater than manager
```sql
CREATE TABLE EMP(
  EMP_ID INT, 
  EMP_NAME VARCHAR(10), 
  SALARY INT, 
  MANAGER_ID INT
);

INSERT INTO EMP VALUES(1,'Ankit',10000,4);
INSERT INTO EMP VALUES(2,'Mohit',15000,5);
INSERT INTO EMP VALUES(3,'Vikas',10000,4);
INSERT INTO EMP VALUES(4,'Rohit',5000,2);
INSERT INTO EMP VALUES(5,'Mudit',12000,6);
INSERT INTO EMP VALUES(6,'Agam',12000,2);
INSERT INTO EMP VALUES(7,'Sanjay',9000,2);
INSERT INTO EMP VALUES(8,'Ashish',5000,2);

SELECT * FROM EMP;

SELECT 
  E.EMP_ID, 
  E.EMP_NAME, 
  M.EMP_NAME AS MANAGER_NAME, 
  E.SALARY, 
  M.SALARY AS MANAGER_SALARY 
FROM 
  EMP E 
  LEFT JOIN EMP M ON E.MANAGER_ID = M.EMP_ID 
WHERE 
  E.SALARY > M.SALARY
```
##  New and Repeat Customers
```sql
CREATE TABLE CUSTOMER_ORDERS (
  ORDER_ID INTEGER,
  CUSTOMER_ID INTEGER,
  ORDER_DATE DATE,
  ORDER_AMOUNT INTEGER
);

INSERT INTO CUSTOMER_ORDERS VALUES
(1,100,CAST('2022-01-01' AS DATE),2000),
(2,200,CAST('2022-01-01' AS DATE),2500),
(3,300,CAST('2022-01-01' AS DATE),2100),
(4,100,CAST('2022-01-02' AS DATE),2000),
(5,400,CAST('2022-01-02' AS DATE),2200),
(6,500,CAST('2022-01-02' AS DATE),2700),
(7,100,CAST('2022-01-03' AS DATE),3000),
(8,400,CAST('2022-01-03' AS DATE),1000),
(9,600,CAST('2022-01-03' AS DATE),3000);

SELECT * FROM CUSTOMER_ORDERS;

SELECT 
  A.ORDER_DATE, 
  COUNT(CASE WHEN B.CUSTOMER_ID IS NULL THEN 1 END) AS NEW_CUSTOMERS, 
  COUNT(DISTINCT B.CUSTOMER_ID) AS REPEAT_CUSTOMERS 
FROM 
  CUSTOMER_ORDERS A 
  LEFT JOIN CUSTOMER_ORDERS B ON A.ORDER_DATE > B.ORDER_DATE 
  AND A.CUSTOMER_ID = B.CUSTOMER_ID 
GROUP BY 
  A.ORDER_DATE;
  
WITH FIRST_VISIT AS (
  SELECT 
    CUSTOMER_ID, 
    MIN(ORDER_DATE) AS FIRST_VISIT_DATE 
  FROM 
    CUSTOMER_ORDERS 
  GROUP BY 
    CUSTOMER_ID
) 
SELECT 
  CO.ORDER_DATE, 
  SUM(
    CASE WHEN CO.ORDER_DATE = FV.FIRST_VISIT_DATE THEN 1 ELSE 0 END
  ) AS FIRST_VISIT_FLAG, 
  SUM(
    CASE WHEN CO.ORDER_DATE != FV.FIRST_VISIT_DATE THEN 1 ELSE 0 END
  ) AS REPEAT_VISIT_FLAG 
FROM 
  CUSTOMER_ORDERS CO 
  INNER JOIN FIRST_VISIT FV ON CO.CUSTOMER_ID = FV.CUSTOMER_ID 
GROUP BY 
  CO.ORDER_DATE;
```
## Most Visited Floor
```sql
CREATE TABLE ENTRIES (
  NAME VARCHAR(20), 
  ADDRESS VARCHAR(20), 
  EMAIL VARCHAR(20), 
  FLOOR INT, 
  RESOURCES VARCHAR(10)
);
INSERT INTO ENTRIES 
VALUES 
  ('A','Bangalore','A@gmail.com', 1,'CPU'), 
  ('A','Bangalore','A1@gmail.com',1,'CPU'), 
  ('A','Bangalore','A2@gmail.com',2,'DESKTOP'), 
  ('B','Bangalore','B@gmail.com', 2,'DESKTOP'), 
  ('B','Bangalore','B1@gmail.com',2,'DESKTOP'), 
  ('B','Bangalore','B2@gmail.com',1,'MONITOR');
SELECT 
  * 
FROM 
  ENTRIES;

WITH VISIT_DATA AS (
  SELECT 
    NAME, 
    FLOOR, 
    SUM(COUNT(FLOOR)) OVER (PARTITION BY NAME) AS TOTAL_VISIT, 
    RANK() OVER (PARTITION BY NAME ORDER BY COUNT(FLOOR) DESC) AS RNK 
  FROM 
    ENTRIES 
  GROUP BY 
    NAME, 
    FLOOR
), 
RESOURCES_DATA AS (
  SELECT 
    NAME, 
    STRING_AGG(RESOURCES, ',') AS RESOURCES_USED 
  FROM 
    (
      SELECT 
        DISTINCT NAME, RESOURCES 
      FROM 
        ENTRIES
    ) A 
  GROUP BY 
    NAME
) 
SELECT 
  A.NAME, 
  TOTAL_VISIT, 
  A.FLOOR AS MOST_VISITED_FLOOR, 
  RESOURCES_USED 
FROM 
  VISIT_DATA A 
  LEFT JOIN RESOURCES_DATA B ON A.NAME = B.NAME 
WHERE 
  RNK = 1
```
## Pivot Unpivot Fixed
```sql
CREATE TABLE EMP_COMPENSATION (
  EMP_ID INT, 
  SALARY_COMPONENT_TYPE VARCHAR(20), 
  VAL INT
);
INSERT INTO EMP_COMPENSATION 
VALUES 
  (1, 'salary', 10000), 
  (1, 'bonus', 5000), 
  (1, 'hike_percent', 10), 
  (2, 'salary', 15000), 
  (2, 'bonus', 7000), 
  (2, 'hike_percent', 8), 
  (3, 'salary', 12000), 
  (3, 'bonus', 6000), 
  (3, 'hike_percent', 7);
SELECT 
  * 
FROM 
  EMP_COMPENSATION;
  
WITH PIVOT_DATA AS (
  SELECT 
    EMP_ID, 
    MAX(CASE WHEN SALARY_COMPONENT_TYPE = 'salary' THEN VAL END) AS SALARY, 
    MAX(CASE WHEN SALARY_COMPONENT_TYPE = 'bonus' THEN VAL END) AS BONUS, 
    MAX(CASE WHEN SALARY_COMPONENT_TYPE = 'hike_percent' THEN VAL END) AS HIKE_PERCENT 
  FROM 
    EMP_COMPENSATION 
  GROUP BY 
    EMP_ID
), 
UNPIVOT_DATA AS (
  SELECT 
    EMP_ID, 
    'salary' AS SALARY_COMPONENT_TYPE, 
    SALARY AS VAL 
  FROM 
    PIVOT_DATA 
  UNION 
  SELECT 
    EMP_ID, 
    'bonus' AS SALARY_COMPONENT_TYPE, 
    BONUS AS VAL 
  FROM 
    PIVOT_DATA 
  UNION 
  SELECT 
    EMP_ID, 
    'hike_percent' AS SALARY_COMPONENT_TYPE, 
    HIKE_PERCENT AS VAL 
  FROM 
    PIVOT_DATA
) 
SELECT 
  * 
FROM 
  PIVOT_DATA;
```
## Nth Sunday Date from current data
```sql
SET 
  DATEFIRST 1;
-- Sets Monday as the first day of the week
WITH TODAY_DT AS (
  SELECT 
    CAST(GETDATE() AS DATE) AS DT
), 
FIRST_SUNDAY AS (
  SELECT 
    DT AS CURR_DT, 
    DATENAME(WEEKDAY, DT) AS CURR_DAY, 
    DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), DT) AS FIRST_SUNDAY 
  FROM 
    TODAY_DT
) 
SELECT 
   DATEADD(DAY,1*7,FIRST_SUNDAY) AS NTH_SUNDAY
FROM 
  FIRST_SUNDAY
```
## Friends Score
```sql
CREATE TABLE FRIEND (PID INT, FID INT);
INSERT INTO FRIEND (PID , FID ) VALUES ('1','2');
INSERT INTO FRIEND (PID , FID ) VALUES ('1','3');
INSERT INTO FRIEND (PID , FID ) VALUES ('2','1');
INSERT INTO FRIEND (PID , FID ) VALUES ('2','3');
INSERT INTO FRIEND (PID , FID ) VALUES ('3','5');
INSERT INTO FRIEND (PID , FID ) VALUES ('4','2');
INSERT INTO FRIEND (PID , FID ) VALUES ('4','3');
INSERT INTO FRIEND (PID , FID ) VALUES ('4','5');

CREATE TABLE PERSON (PERSONID INT,	NAME VARCHAR(50),	SCORE INT);
INSERT INTO PERSON(PERSONID,NAME ,SCORE) VALUES('1','ALICE','88');
INSERT INTO PERSON(PERSONID,NAME ,SCORE) VALUES('2','BOB','11');
INSERT INTO PERSON(PERSONID,NAME ,SCORE) VALUES('3','DEVIS','27');
INSERT INTO PERSON(PERSONID,NAME ,SCORE) VALUES('4','TARA','45');
INSERT INTO PERSON(PERSONID,NAME ,SCORE) VALUES('5','JOHN','63');

SELECT * FROM PERSON;
SELECT * FROM FRIEND;

SELECT 
  * 
FROM 
  (
    SELECT 
      P.PERSONID AS PID, 
      P.NAME AS PERSON_NAME, 
      COUNT(*) AS NO_OF_FRIENDS, 
      SUM(P2.SCORE) AS TOTAL_FRIEND_SCORE 
    FROM 
      PERSON P 
      LEFT JOIN FRIEND F ON P.PERSONID = F.PID 
      LEFT JOIN PERSON P2 ON P2.PERSONID = F.FID 
    GROUP BY 
      P.PERSONID, 
      P.NAME, 
      P.SCORE
  ) A 
WHERE 
  TOTAL_FRIEND_SCORE > 100
```
## Trips & User
```sql
CREATE TABLE TRIPS (
  ID INT, 
  CLIENT_ID INT, 
  DRIVER_ID INT, 
  CITY_ID INT, 
  STATUS VARCHAR(50), 
  REQUEST_AT VARCHAR(50)
);
CREATE TABLE USERS (
  USERS_ID INT, 
  BANNED VARCHAR(50), 
  ROLE VARCHAR(50)
);

INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('1', '1', '10', '1', 'COMPLETED', '2013-10-01');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('2', '2', '11', '1', 'CANCELLED_BY_DRIVER', '2013-10-01');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('3', '3', '12', '6', 'COMPLETED', '2013-10-01');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('4', '4', '13', '6', 'CANCELLED_BY_CLIENT', '2013-10-01');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('5', '1', '10', '1', 'COMPLETED', '2013-10-02');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('6', '2', '11', '6', 'COMPLETED', '2013-10-02');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('7', '3', '12', '6', 'COMPLETED', '2013-10-02');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('8', '2', '12', '12', 'COMPLETED', '2013-10-03');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('9', '3', '10', '12', 'COMPLETED', '2013-10-03');
INSERT INTO TRIPS (ID, CLIENT_ID, DRIVER_ID, CITY_ID, STATUS, REQUEST_AT) VALUES ('10', '4', '13', '12', 'CANCELLED_BY_DRIVER', '2013-10-03');


INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('1', 'NO', 'CLIENT');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('2', 'YES', 'CLIENT');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('3', 'NO', 'CLIENT');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('4', 'NO', 'CLIENT');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('10', 'NO', 'DRIVER');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('11', 'NO', 'DRIVER');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('12', 'NO', 'DRIVER');
INSERT INTO USERS (USERS_ID, BANNED, ROLE) VALUES ('13', 'NO', 'DRIVER');


SELECT 
  REQUEST_AT, 
  (
    SUM(
      CASE WHEN STATUS IN (
        'CANCELLED_BY_DRIVER', 'CANCELLED_BY_CLIENT'
      ) THEN 1 ELSE 0 END
    ) * 100.00 / COUNT(*)
  ) AS CANC_RATE 
FROM 
  TRIPS T 
  INNER JOIN USERS C ON T.CLIENT_ID = C.USERS_ID 
  AND C.ROLE = 'CLIENT' 
  AND C.BANNED = 'NO' 
  INNER JOIN USERS D ON T.DRIVER_ID = D.USERS_ID 
  AND D.ROLE = 'DRIVER' 
  AND D.BANNED = 'NO' 
GROUP BY 
  REQUEST_AT
```